from artiq.experiment import *
import numpy as np
from artiq.coredevice.ad9910 import AD9910, SyncDataEeprom
from artiq.coredevice.ad53xx import AD53xx
from artiq.master.databases import DeviceDB
from artiq.master.worker_db import DeviceManager
from datetime import datetime
import time
import os
import sys
import csv
# import visa

class zotino_calibrator(EnvExperiment):
    def build(self): 
        self.setattr_device("core")                
        self.setattr_device("zotino0")  
        self.setattr_device("ttl16")
        self.setattr_argument('voltage',NumberValue(default=1,unit='V',scale=1,ndecimals=2,step=1))
        self.setattr_argument('pin',NumberValue(default=0,unit=' ',scale=1,ndecimals=0, step=1))
        self.setattr_argument("voltage_scan", BooleanValue(default=True))
        
    def prepare(self):
        # self.Vs = np.arange(-10,10,1)
        # self.Vs = [-10.0,-9.0,-8.0,-7.0,-6.0,-5.0,-4.0,-3.0,-2.0,-1.0,0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,9.9]
        self.Vs = [-9.5,-8.5,-7.5,-6.5,-5.5,-4.5,-3.5,-2.5,-1.5,-0.5,0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5]
        '''
        self.offset = [[8.25280000e-03, 7.92384000e-03, 7.51424000e-03, 7.40224000e-03,6.95808000e-03, 6.54752000e-03, 6.06240000e-03, 5.61504000e-03,5.50704000e-03, 5.01168000e-03, 4.49822624e-03, 4.01318400e-03,3.36912000e-03, 3.22304000e-03, 2.64480000e-03, 2.05888000e-03,1.51104000e-03, 9.22240000e-04, 6.22720000e-04, 6.40000000e-07,6.40000000e-07],\
                      [ 4.11680000e-03,  3.69664000e-03,  3.20512000e-03,  2.94272000e-03,2.41408000e-03,  1.96256000e-03,  1.43520000e-03,  9.04640000e-04,6.36800000e-04,  7.08000000e-05, -4.94394976e-04, -1.07408000e-03,-1.84992000e-03, -2.10368000e-03, -2.75456000e-03, -3.38592000e-03,-4.04096000e-03, -4.78016000e-03, -5.14816000e-03, -5.85152000e-03,-5.85152000e-03],\
                      [ 8.00880000e-03,  7.65696000e-03,  7.16672000e-03,  6.99392000e-03,6.55808000e-03,  6.09888000e-03,  5.58656000e-03,  5.08544000e-03,4.89600000e-03,  4.34864000e-03,  3.82412704e-03,  3.23961600e-03,2.64768000e-03,  2.42272000e-03,  1.81536000e-03,  1.18496000e-03,5.45920000e-04, -3.71200000e-05, -3.87840000e-04, -1.09184000e-03,-1.09184000e-03],\
                      [ 7.04640000e-03,  6.62720000e-03,  5.93280000e-03,  5.98528000e-03,5.46432000e-03,  5.06368000e-03,  4.53568000e-03,  3.99712000e-03,3.81664000e-03,  3.26600000e-03,  2.69681472e-03,  2.13664000e-03,1.45664000e-03,  1.25120000e-03,  6.11520000e-04, -3.10400000e-05,-6.46400000e-04, -1.28256000e-03, -1.59744000e-03, -2.23936000e-03,-2.23936000e-03],\
                      [ 0.0041024 ,  0.00368768,  0.00317696,  0.00298944,  0.00246016,0.00204416,  0.00150336,  0.00094592,  0.00077792,  0.0002304 ,-0.00035919, -0.00094912, -0.0016336 , -0.00197184, -0.0025296 ,-0.00315328, -0.00378048, -0.0044576 , -0.00457216, -0.00524032,-0.00524032],\
                      [ 0.0089224 ,  0.00855168,  0.00802624,  0.00784128,  0.00729984,0.00680576,  0.00599904,  0.00578432,  0.0054384 ,  0.0049212 ,0.00430411,  0.00368198,  0.00300672,  0.00271552,  0.00210656,0.00145856,  0.00077376,  0.00015488, -0.00024192, -0.0010016 ,-0.0010016 ],\
                      [ 0.0093872 ,  0.00910208,  0.00851712,  0.00840192,  0.00788608,0.00738944,  0.00684832,  0.00637184,  0.00604176,  0.0055224 ,0.00496137,  0.00430758,  0.00368944,  0.0033344 ,  0.00274272,0.00207296,  0.0014208 ,  0.0007648 ,  0.00039424, -0.00035648,-0.00035648],\
                      [ 0.0053736 ,  0.00514688,  0.00473216,  0.0045856 ,  0.00423104,0.00386048,  0.00344288,  0.00301792,  0.00289104,  0.0024372 ,0.00199873,  0.00150912,  0.00095568,  0.00077952,  0.00030464,-0.00024352, -0.0005408 , -0.00131712, -0.00160384, -0.002208  ,-0.002208  ],\
                      [ 6.4224000e-03,  5.8604800e-03,  4.3724800e-03,  4.7641600e-03,4.0441600e-03,  3.3772800e-03,  2.6764800e-03,  1.9228800e-03,1.5099200e-03,  6.8464000e-04, -5.9282848e-05, -7.9920000e-04,-1.6350400e-03, -2.1510400e-03, -2.9059200e-03, -3.7126400e-03,-4.5510400e-03, -5.3587200e-03, -5.9660800e-03, -6.9472000e-03,-6.9472000e-03],\
                      [ 0.0093744 ,  0.00877888,  0.00806592,  0.00776448,  0.00701888,0.00645536,  0.00573728,  0.00499712,  0.0046272 ,  0.00389728,0.00314589,  0.00235149,  0.00159952,  0.00117824,  0.0004064 ,-0.00042592, -0.00120512, -0.0020704 , -0.00261888, -0.00351424,-0.00351424],\
                      [ 0.0040128 ,  0.00346688,  0.00262912,  0.00226944,  0.00154432,0.00087744,  0.00012576, -0.00066368, -0.00103696, -0.00162042,-0.00266076, -0.0034072 , -0.00419552, -0.004296  , -0.00504832,-0.0063872 , -0.00726784, -0.00811392, -0.0079744 , -0.0096352 ,-0.0096352 ],\
                      [ 0.0062448 ,  0.00469888,  0.00482368,  0.00439744,  0.00296832,0.0030256 ,  0.00230784,  0.00145984,  0.00104528,  0.00022016,-0.00055953, -0.00130592, -0.00213168, -0.00267296, -0.00351232,-0.00433984, -0.00519872, -0.00608704, -0.00668544, -0.00765056,-0.00765056],\
                      [ 0.0080784 ,  0.00753216,  0.00684096,  0.00647936,  0.00581888,0.00515424,  0.00447328,  0.00376256,  0.00336544,  0.00258504,0.0018629 ,  0.00112378,  0.00031792,  0.00026528, -0.00086688,-0.00169568, -0.00251584, -0.00326784, -0.00387648, -0.00476736,-0.00476736],\
                      [ 0.0070296 ,  0.00644416,  0.00575936,  0.00537216,  0.00475072,0.00417568,  0.00309472,  0.00274304,  0.00231504,  0.00164416,0.00089554,  0.00018528, -0.0005248 , -0.00101856, -0.00175104,-0.00250688, -0.00332864, -0.00410752, -0.0046208 , -0.0055392 ,-0.0055392 ],\
                      [ 9.43200000e-03,  8.63104000e-03,  8.16512000e-03,  7.87264000e-03,7.20896000e-03,  6.65856000e-03,  5.99328000e-03,  5.27296000e-03,4.85712000e-03,  4.15136000e-03,  3.48979264e-03,  2.77766400e-03,2.01088000e-03,  1.57472000e-03,  8.05120000e-04,  6.62400000e-05,-7.28960000e-04, -9.01120000e-04, -2.07168000e-03, -2.94272000e-03,-2.94272000e-03],\
                      [ 0.0062344 ,  0.00573632,  0.0041312 ,  0.00465536,  0.00399232,0.00345184,  0.00276992,  0.002056  ,  0.00171328,  0.0009824 ,0.00025826, -0.00041584, -0.0011496 , -0.0015728 , -0.00228064,-0.00317376, -0.00387008, -0.00468992, -0.00516672, -0.00602176,-0.00602176],\
                      [ 0.0080096 ,  0.00728704,  0.00652416,  0.00607424,  0.00537152,0.0046016 ,  0.0038592 ,  0.00313344,  0.00256176,  0.00179944,0.00100532,  0.00014406, -0.00066944, -0.0012704 , -0.00199328,-0.0028816 , -0.00380736, -0.00465472, -0.00524608, -0.0061856 ,-0.0061856 ],\
                      [-0.00082496, -0.00150784, -0.00229184, -0.00272128, -0.00347328,-0.00421088, -0.00499232, -0.005784  , -0.00628672, -0.00712205,-0.00792615, -0.0087676 , -0.00959136, -0.010176  , -0.01097632,-0.01181696, -0.01267392, -0.0136384 , -0.01424704, -0.01520448,-0.01520448],\
                      [-0.00133696, -0.00200384, -0.00276736, -0.00317184, -0.00391744,-0.00465504, -0.00538944, -0.00615136, -0.00664096, -0.0074361 ,-0.00821122, -0.00903536, -0.00988032, -0.01042656, -0.01117952,-0.01203488, -0.01286912, -0.01380224, -0.014368  , -0.01527104,-0.01527104],\
                      [ 0.0043672 ,  0.00364672,  0.00297152,  0.00262912,  0.00194944,0.00124608,  0.00054208, -0.000192  , -0.00056704, -0.00140934,-0.00213815, -0.00290368, -0.00366144, -0.00416064, -0.00489248,-0.00573152, -0.0066016 , -0.0074176 , -0.0079776 , -0.0087936 ,-0.0087936 ],\
                      [ 0.0041872 ,  0.00349312,  0.00271232,  0.00236672,  0.00171072,0.00095424,  0.00028704, -0.00042752, -0.00090192, -0.00167328,-0.00240376, -0.00315872, -0.00402592, -0.00449664, -0.0053072 ,-0.00608384, -0.00695488, -0.00774016, -0.00827008, -0.00924416,-0.00924416],\
                      [ 0.0056848 ,  0.00499456,  0.00443648,  0.00407104,  0.00349504,0.00281536,  0.0021696 ,  0.00159136,  0.0011192 ,  0.00046552,-0.00023951, -0.00097896, -0.00172064, -0.00218656, -0.0028    ,-0.00359904, -0.00441088, -0.00513856, -0.00563712, -0.00645952,-0.00645952],\
                      [-0.00070208, -0.00135488, -0.0020096 , -0.00243328, -0.0030624 ,-0.0037408 , -0.00443232, -0.00509792, -0.00557264, -0.0063495 ,-0.00707038, -0.00787256, -0.00856656, -0.0090752 , -0.0098048 ,-0.01063456, -0.01144192, -0.01226048, -0.01280512, -0.01369216,-0.01369216],\
                      [ 4.01520000e-03,  3.28640000e-03,  2.58816000e-03,  2.16192000e-03,1.44704000e-03,  6.80960000e-04, -2.46400000e-05, -7.70240000e-04,-1.21696000e-03, -2.01606400e-03, -2.82684544e-03, -3.61704000e-03,-4.48800000e-03, -5.03904000e-03, -5.78656000e-03, -6.60992000e-03,-7.51936000e-03, -8.39296000e-03, -8.93568000e-03, -9.88416000e-03,-9.88416000e-03],\
                      [ 0.0056464 ,  0.00503424,  0.0044032 ,  0.003904  ,  0.00347712,0.00283712,  0.0020848 ,  0.00142912,  0.00107952,  0.000388  ,-0.000338  , -0.0011156 , -0.00189808, -0.00225184, -0.0030608 ,-0.00378752, -0.00465344, -0.005424  , -0.00601088, -0.00673984,-0.00673984],\
                      [ 0.007856  ,  0.00717376,  0.00656576,  0.00621952,  0.00550528,0.00479936,  0.00405344,  0.00339136,  0.00298832,  0.00223888,0.00147256,  0.0006231 , -0.00017936, -0.00058464, -0.00146432,-0.00206368, -0.00307776, -0.0038944 , -0.00444864, -0.00513856,-0.00513856],\
                      [ 0.0040056 ,  0.00338368,  0.00285248,  0.00244928,  0.00187648,0.00123648,  0.00057312, -0.00010368, -0.00050112, -0.00114157,-0.0018433 , -0.00265048, -0.00344848, -0.00375008, -0.00454656,-0.00521216, -0.00601216, -0.0068384 , -0.00737408, -0.00813952,-0.00813952],\
                      [ 0.007828  ,  0.0071744 ,  0.00645248,  0.006032  ,  0.00537664,0.0045008 ,  0.00383712,  0.00295264,  0.00269728,  0.001892  ,0.00107593,  0.00017402, -0.00061504, -0.00112096, -0.00195776,-0.00273216, -0.00369152, -0.0045024 , -0.00518208, -0.00602368,-0.00602368],\
                      [0.0141184 , 0.01336768, 0.01290432, 0.01257216, 0.01201152,0.01135488, 0.01066528, 0.01001856, 0.00960784, 0.00900856,0.00825982, 0.00751098, 0.0067848 , 0.0063888 , 0.0056368 ,0.0049056 , 0.00416832, 0.00328384, 0.00286592, 0.00205248,0.00205248],\
                      [ 0.0111376 ,  0.0103872 ,  0.0096512 ,  0.00923776,  0.00854208,0.00779392,  0.00706816,  0.00626944,  0.00576112,  0.0050656 ,0.00421398,  0.00329741,  0.00241056,  0.00190496,  0.00103552,0.00038752, -0.00066688, -0.00158144, -0.00202176, -0.00290752,-0.00290752],\
                      [ 1.09072000e-02,  1.02131200e-02,  9.49888000e-03,  9.12640000e-03,8.42624000e-03,  7.61952000e-03,  6.82272000e-03,  5.94880000e-03,5.55680000e-03,  4.82616000e-03,  4.02887392e-03,  3.08300800e-03,2.25232000e-03,  1.69376000e-03,  8.53120000e-04, -1.28000000e-05,-8.12160000e-04, -1.82272000e-03, -2.41344000e-03, -3.34656000e-03,-3.34656000e-03],\
                      [ 0.0078544 ,  0.00729088,  0.00662784,  0.00633984,  0.00553984,0.00492288,  0.00430432,  0.00362944,  0.00322512,  0.00252008,0.00179726,  0.00096941,  0.00019888, -0.00018624, -0.0010432 ,-0.001688  , -0.00249664, -0.00339072, -0.0038816 , -0.00477696,-0.00477696],\
                      ]
    '''
    def run(self):
        self.loadDACoffset()
        if self.voltage_scan:
            self.run_scan()
        else:
            self.run_once()

    @kernel
    def run_once(self):
        self.core.reset()
        self.core.break_realtime()                                          
        self.zotino0.init()
        for pin in range(32):
            delay(300*us) # avoid RTIO underflow error
            #if dac_vs[pin] < 10:
            self.zotino0.write_dac(pin,self.voltage)
            index = 10+int(np.rint(self.voltage))
            self.zotino0.write_offset(pin,self.offset[pin][index])    
        self.zotino0.load()
        # self.zotino0.write_offset_dacs_mu()

    @kernel
    def run_scan(self):
        self.core.reset()
        self.core.break_realtime()                                          
        self.zotino0.init()
        
        for i in range(len(self.Vs)):
            delay(300*us) # avoid RTIO underflow error
            self.zotino0.write_dac(self.pin,self.Vs[i])
            index = 10+int(np.rint(self.Vs[i]))
            self.zotino0.write_offset(self.pin,self.offset[self.pin][index])
            with parallel:
                self.zotino0.load()
                with sequential:
                    self.ttl16.pulse(20*us)
                    delay(10*us)
            delay(2*s)
            # self.zotino0.write_offset_dacs_mu()

    def loadDACoffset(self):
        # create list of lines from dataset
        f = '/home/electron/artiq/electron/zotino_offset.txt'
        tmp = np.loadtxt(f)
        offset = np.zeros((tmp.shape[0],tmp.shape[1]+1))
        for i in range(tmp.shape[0]):
            a = np.append(tmp[i],tmp[i][-1])
            offset[i] = a
        self.offset = offset

        







